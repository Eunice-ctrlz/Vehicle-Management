{% extends 'fleet/customer_base.html' %}

{% block content %}
<div class="container text-center mt-5">
    <div id="payment-card" class="card bg-dark text-white border-secondary p-5 shadow-lg">
        <div id="status-icon">
            <div class="spinner-border" style="color: #c5a059; width: 3rem; height: 3rem;" role="status"></div>
        </div>
        
        <h2 class="mt-4" id="main-heading">Processing Payment...</h2>
        <p id="sub-heading">Please check your phone and enter your M-Pesa PIN.</p>
        
        <div id="error-actions" class="d-none mt-4">
            <a href="{% url 'fleet:customer-dashboard' %}" class="btn btn-outline-warning">Back to Dashboard</a>
        </div>
        
        <p class="text-muted small mt-4">Do not refresh or close this window.</p>
    </div>
</div>

<script>
    const checkoutId = "{{ checkout_id }}";
    const mainHeading = document.getElementById('main-heading');
    const subHeading = document.getElementById('sub-heading');
    const statusIcon = document.getElementById('status-icon');
    const errorActions = document.getElementById('error-actions');

    let checkStatus = setInterval(function() {
        fetch("{% url 'payments:check_status' checkout_id %}")
        .then(response => response.json())
        .then(data => {
            console.log("M-Pesa Status:", data.status); 
            
            if (data.status === 'Completed') {
                clearInterval(checkStatus);
                statusIcon.innerHTML = '<i class="fas fa-check-circle text-success fa-4x"></i>';
                mainHeading.innerText = "Payment Successful!";
                mainHeading.classList.add('text-success');
                subHeading.innerText = "Redirecting to your bookings...";
                setTimeout(() => {
                    window.location.href = "{% url 'fleet:customer-dashboard' %}";
                }, 2000);
            } 
            
            else if (data.status === 'Failed' || data.status === 'Cancelled') {
                clearInterval(checkStatus);
                statusIcon.innerHTML = '<i class="fas fa-times-circle text-danger fa-4x"></i>';
                mainHeading.innerText = "Payment " + data.status;
                mainHeading.classList.add('text-danger');
                subHeading.innerText = "The transaction was not completed. Please try again.";
                errorActions.classList.remove('d-none');
            }
        })
        .catch(err => console.error('Polling error:', err));
    }, 3000);
</script>
{% endblock %}